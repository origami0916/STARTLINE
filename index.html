<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaCampus - è–¬å‰¤å¸«å‘ã‘å‹•ç”»å­¦ç¿’ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans JP', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .hover-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .hover-card {
            transition: all 0.3s ease;
        }

        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #a78bfa;
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Supabase Setup -->
    <script>
        const SUPABASE_URL = 'https://jzymudoembgafbdcmjni.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6eW11ZG9lbWJnYWZiZGNtam5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzM3NjMsImV4cCI6MjA4MTAwOTc2M30.pTihcUOuDdmBNyE8qSzuEJLcqODn-iKBKelFNr2rB-8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State & Constants
        const DEFAULT_THUMBNAIL = 'https://images.unsplash.com/photo-1587854692152-cbe660dbde88?auto=format&fit=crop&w=600&q=80';
        let currentUser = null;
        let isAdmin = false;

        // Data Stores
        let categories = [];
        let lessons = [];
        let userProgress = [];
        let currentCategory = null;
        let activeLesson = null;
    </script>

    <!-- ========================================
         HEADER
    ======================================== -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="showLearningMode()">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">PharmaCampus</h1>
                </div>

                <div id="userInfo" class="hidden items-center space-x-4">
                    <!-- Admin Button (Hidden by default) -->
                    <button id="adminLinkBtn" onclick="showAdminMode()"
                        class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm font-bold transition flex items-center shadow-lg">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼
                    </button>

                    <div class="text-right hidden md:block">
                        <p id="userEmail" class="text-sm font-medium opacity-90"></p>
                    </div>
                    <button onclick="logout()"
                        class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition backdrop-blur-sm">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ========================================
         MAIN CONTENT
    ======================================== -->
    <main class="flex-grow container mx-auto px-4 py-8 relative">

        <!-- 1. AUTH SECTION -->
        <div id="authSection" class="max-w-md mx-auto pt-10 fade-in">
            <div class="flex mb-6 bg-white rounded-xl p-1 card-shadow">
                <button id="loginTab" onclick="showTab('login')"
                    class="flex-1 py-3 px-4 rounded-lg font-medium transition bg-purple-600 text-white">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="registerTab" onclick="showTab('register')"
                    class="flex-1 py-3 px-4 rounded-lg font-medium transition text-gray-600 hover:bg-gray-100">æ–°è¦ç™»éŒ²</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="bg-white rounded-2xl p-8 card-shadow fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ãŠã‹ãˆã‚Šãªã•ã„</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="loginEmail" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 transition"
                            placeholder="example@email.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="loginPassword" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 transition"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium shadow-lg shadow-purple-200 transition">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </form>
                <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden bg-white rounded-2xl p-8 card-shadow fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="registerEmail" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 transition">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="registerPassword" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 transition">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">è–¬å‰¤å¸«å…è¨±ç•ªå· <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="licenseNumber" required pattern="[0-9]+"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 transition"
                            placeholder="123456">
                    </div>
                    <button type="submit"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium shadow-lg shadow-purple-200 transition">æ–°è¦ç™»éŒ²</button>
                </form>
                <div id="registerError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
                <div id="registerSuccess" class="mt-4 text-green-500 text-sm text-center hidden"></div>
            </div>
        </div>

        <!-- 2. LEARNING SECTION (User View) -->
        <div id="learningSection" class="hidden">
            <!-- Breadcrumbs -->
            <nav class="flex mb-6 text-sm font-medium text-gray-500" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li><a href="#" onclick="showLearningMode()" class="hover:text-purple-600 transition">ãƒ›ãƒ¼ãƒ </a></li>
                    <li id="breadcrumbSeparator" class="hidden text-gray-400">/</li>
                    <li id="breadcrumbCurrent" class="hidden text-purple-600 font-bold" aria-current="page"></li>
                </ol>
            </nav>

            <!-- Categories View -->
            <div id="categoryView" class="fade-in">
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-3">å­¦ç¿’ã‚³ãƒ¼ã‚¹ã‚’é¸æŠ</h2>
                    <p class="text-gray-600">æ–°ã—ã„çŸ¥è­˜ã‚’ç©ã¿ä¸Šã’ã¦ã„ãã¾ã—ã‚‡ã†</p>
                </div>
                <div id="categoryList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 max-w-6xl mx-auto">
                    <!-- Dynamic Categories -->
                </div>
            </div>

            <!-- Lessons View -->
            <div id="lessonView" class="hidden fade-in">
                <div class="mb-8 flex items-end justify-between">
                    <div>
                        <h2 id="currentCategoryTitle" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                        <p id="currentCategoryDesc" class="text-gray-600"></p>
                    </div>
                    <div class="hidden md:block">
                        <div class="text-right mb-1 text-sm font-medium text-purple-600">ã‚³ãƒ¼ã‚¹é€²æ—</div>
                        <div class="w-48 bg-gray-200 rounded-full h-2">
                            <div id="courseProgressBar"
                                class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="lessonList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    <!-- Dynamic Lessons -->
                </div>
            </div>
        </div>

        <!-- 3. ADMIN SECTION (Dashboard & Management) -->
        <div id="adminSection"
            class="hidden min-h-[600px] bg-white rounded-2xl shadow-xl overflow-hidden flex border border-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-slate-800 text-white flex-shrink-0">
                <div class="p-6 border-b border-slate-700">
                    <h2 class="text-xl font-bold tracking-wider">ç®¡ç†è€…è¨­å®š</h2>
                    <p class="text-xs text-gray-400 mt-1">Management Console</p>
                </div>
                <nav class="mt-4 space-y-1">
                    <button onclick="switchAdminTab('dashboard')" id="nav-dashboard"
                        class="sidebar-link active w-full text-left px-6 py-4 hover:bg-white/5 transition flex items-center">
                        <span class="mr-3">ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </button>
                    <button onclick="switchAdminTab('categories')" id="nav-categories"
                        class="sidebar-link w-full text-left px-6 py-4 hover:bg-white/5 transition flex items-center">
                        <span class="mr-3">ğŸ“‚</span> ã‚«ãƒ†ã‚´ãƒªç®¡ç†
                    </button>
                    <button onclick="switchAdminTab('lessons')" id="nav-lessons"
                        class="sidebar-link w-full text-left px-6 py-4 hover:bg-white/5 transition flex items-center">
                        <span class="mr-3">ğŸ¥</span> ãƒ¬ãƒƒã‚¹ãƒ³ç®¡ç†
                    </button>
                    <button onclick="switchAdminTab('users')" id="nav-users"
                        class="sidebar-link w-full text-left px-6 py-4 hover:bg-white/5 transition flex items-center">
                        <span class="mr-3">ğŸ‘¥</span> ä¼šå“¡ãƒ»é€²æ—
                    </button>
                    <div class="pt-8 px-6">
                        <button onclick="showLearningMode()"
                            class="w-full border border-slate-600 rounded text-slate-400 py-2 hover:bg-slate-700 hover:text-white transition">â†
                            å­¦ç¿’ç”»é¢ã«æˆ»ã‚‹</button>
                    </div>
                </nav>
            </aside>

            <!-- Admin Content -->
            <div class="flex-1 p-8 overflow-y-auto max-h-[800px]">
                <h3 id="adminPageTitle" class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>

                <!-- Admin: Dashboard View -->
                <div id="view-dashboard" class="space-y-6 fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                            <div class="text-blue-600 text-sm mb-1 font-bold">ç·ä¼šå“¡æ•°</div>
                            <div class="text-3xl font-bold text-gray-800" id="stat-users">-</div>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-xl border border-purple-100">
                            <div class="text-purple-600 text-sm mb-1 font-bold">æå‡ºã•ã‚ŒãŸæ„Ÿæƒ³</div>
                            <div class="text-3xl font-bold text-gray-800" id="stat-feedback">-</div>
                        </div>
                        <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                            <div class="text-green-600 text-sm mb-1 font-bold">å…¬é–‹ä¸­ã®å‹•ç”»</div>
                            <div class="text-3xl font-bold text-gray-800" id="stat-lessons">-</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-100 mt-6">
                        <div class="p-4 border-b bg-gray-50 font-bold text-gray-700">æœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
                        <div id="feed-timeline" class="divide-y divide-gray-100 max-h-[400px] overflow-y-auto">
                            <!-- Items -->
                        </div>
                    </div>
                </div>

                <!-- Admin: Categories -->
                <div id="view-categories" class="hidden space-y-6 fade-in">
                    <div class="flex justify-end">
                        <button onclick="openCategoryModal()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium shadow">+
                            æ–°è¦ã‚«ãƒ†ã‚´ãƒª</button>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3">é †åº</th>
                                <th class="px-6 py-3">ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th class="px-6 py-3">èª¬æ˜</th>
                                <th class="px-6 py-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="adminCategoryTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <!-- Admin: Lessons -->
                <div id="view-lessons" class="hidden space-y-6 fade-in">
                    <div class="flex justify-end">
                        <button onclick="openLessonModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow">+
                            æ–°è¦ãƒ¬ãƒƒã‚¹ãƒ³</button>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3">ã‚«ãƒ†ã‚´ãƒª</th>
                                <th class="px-6 py-3">é †åº</th>
                                <th class="px-6 py-3">ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th class="px-6 py-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="adminLessonTable" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>

                <!-- Admin: Users -->
                <div id="view-users" class="hidden space-y-6 fade-in">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                                <th class="px-6 py-3">å®Œäº†æ•°</th>
                                <th class="px-6 py-3">æœ€çµ‚å­¦ç¿’</th>
                            </tr>
                        </thead>
                        <tbody id="adminUserTable" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- ========================================
         MODALS
    ======================================== -->

    <!-- 1. Video Player Modal -->
    <div id="videoModal" class="fixed inset-0 bg-black/95 z-50 hidden overflow-y-auto h-full w-full">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-4xl overflow-hidden relative shadow-2xl">
                <button onclick="closeVideoModal()"
                    class="absolute top-4 right-4 z-10 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="grid lg:grid-cols-3">
                    <div class="lg:col-span-2 bg-black flex items-center justify-center">
                        <iframe id="videoPlayer" class="w-full aspect-video" frameborder="0"
                            allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                    <div class="lg:col-span-1 p-6 flex flex-col h-full max-h-[600px] overflow-y-auto bg-gray-50">
                        <h3 id="modalLessonTitle" class="text-lg font-bold text-gray-800 mb-1"></h3>
                        <div id="feedbackFormContainer" class="flex-1 flex flex-col pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æœ¬æ—¥ã®å­¦ã³ï¼ˆã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼‰</label>
                            <p class="text-xs text-gray-500 mb-2"><span id="minCharCount">20</span>æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            <textarea id="feedbackText" rows="6"
                                class="w-full p-3 rounded-lg border-gray-200 border text-sm mb-2 resize-none"
                                placeholder="æ„Ÿæƒ³ã‚’å…¥åŠ›..." oninput="validateFeedback()"></textarea>
                            <div class="flex justify-between items-center mb-4">
                                <span id="charCount" class="text-xs text-gray-400">0æ–‡å­—</span>
                                <span id="statusMessage" class="text-xs text-red-500 font-medium">ã‚ã¨<span
                                        id="remainingChars">20</span>æ–‡å­—</span>
                            </div>
                            <button id="submitFeedbackBtn" onclick="submitFeedback()" disabled
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold text-sm disabled:opacity-50 transition">é€ä¿¡ã—ã¦å®Œäº†</button>
                        </div>
                        <div id="completedView" class="hidden flex-col items-center justify-center flex-1 py-8">
                            <div
                                class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-4">
                                âœ“</div>
                            <p class="font-bold text-gray-800">å­¦ç¿’å®Œäº†æ¸ˆã¿</p>
                            <p id="pastFeedback"
                                class="text-sm text-gray-600 mt-4 italic bg-white p-3 rounded w-full border"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Admin Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-4">ã‚«ãƒ†ã‚´ãƒªä½œæˆ</h3>
            <form onsubmit="handleCategorySubmit(event)">
                <input type="text" name="title" required placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border rounded-lg p-3 mb-3">
                <textarea name="description" placeholder="èª¬æ˜" class="w-full border rounded-lg p-3 mb-3"></textarea>
                <input type="number" name="order" value="1" placeholder="è¡¨ç¤ºé †" class="w-full border rounded-lg p-3 mb-6">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('categoryModal').classList.add('hidden')"
                        class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Admin Lesson Modal -->
    <div id="lessonModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">ãƒ¬ãƒƒã‚¹ãƒ³è¿½åŠ </h3>
            <form onsubmit="handleLessonSubmit(event)">
                <label class="text-xs text-gray-500">ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="lessonCategorySelect" name="category_id" required
                    class="w-full border rounded-lg p-3 mb-3"></select>

                <label class="text-xs text-gray-500">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" name="title" required class="w-full border rounded-lg p-3 mb-3">

                <label class="text-xs text-gray-500">YouTube URL</label>
                <input type="text" name="video_url" required placeholder="https://www.youtube.com/watch?v=..."
                    class="w-full border rounded-lg p-3 mb-3 font-mono text-sm">

                <label class="text-xs text-gray-500">ã‚µãƒ ãƒã‚¤ãƒ«URL (ä»»æ„)</label>
                <input type="text" name="thumbnail_url" placeholder="ç©ºæ¬„ãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"
                    class="w-full border rounded-lg p-3 mb-3 font-mono text-sm">

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label class="text-xs text-gray-500">é †åº</label><input type="number" name="order" value="1"
                            class="w-full border rounded-lg p-3"></div>
                    <div><label class="text-xs text-gray-500">å¿…é ˆæ–‡å­—æ•°</label><input type="number" name="min_length"
                            value="20" class="w-full border rounded-lg p-3"></div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('lessonModal').classList.add('hidden')"
                        class="px-4 py-2 text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t mt-auto py-8 text-center text-gray-400 text-sm">
        <p>Â© 2024 PharmaCampus</p>
    </footer>

    <!-- ========================================
         SCRIPTS
    ======================================== -->
    <script>
        // --- Helper ---
        function extractVideoId(url) {
            if (!url) return null;
            if (url.length === 11) return url;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- Auth & Init Logic ---
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await checkAdminStatus(currentUser);
                showLearningMode();
            } else {
                showAuthMode();
            }

            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await checkAdminStatus(currentUser);
                    showLearningMode();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    isAdmin = false;
                    document.getElementById('adminLinkBtn').classList.add('hidden');
                    showAuthMode();
                }
            });
        }

        async function checkAdminStatus(user) {
            try {
                const { data } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                isAdmin = (data && data.role === 'admin');
                if (isAdmin) {
                    document.getElementById('adminLinkBtn').classList.remove('hidden');
                } else {
                    document.getElementById('adminLinkBtn').classList.add('hidden');
                }
            } catch (e) { console.error(e); }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        function showTab(tab) {
            document.getElementById('loginTab').className = tab === 'login' ? 'flex-1 py-3 px-4 rounded-lg font-medium transition bg-purple-600 text-white' : 'flex-1 py-3 px-4 rounded-lg font-medium transition text-gray-600 hover:bg-gray-100';
            document.getElementById('registerTab').className = tab === 'register' ? 'flex-1 py-3 px-4 rounded-lg font-medium transition bg-purple-600 text-white' : 'flex-1 py-3 px-4 rounded-lg font-medium transition text-gray-600 hover:bg-gray-100';
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const { error } = await supabase.auth.signInWithPassword({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            });
            if (error) document.getElementById('loginError').classList.remove('hidden').textContent = error.message;
        }

        async function handleRegister(e) {
            e.preventDefault();
            const { error } = await supabase.auth.signUp({
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value,
                options: { data: { license_number: document.getElementById('licenseNumber').value } }
            });
            if (error) {
                document.getElementById('registerError').classList.remove('hidden').textContent = error.message;
            } else {
                document.getElementById('registerSuccess').classList.remove('hidden').textContent = 'ç™»éŒ²å®Œäº†ã€‚ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                setTimeout(() => showTab('login'), 3000);
            }
        }

        // --- Mode Switching ---

        function showAuthMode() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('learningSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showLearningMode() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('learningSection').classList.remove('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('flex');
            document.getElementById('userEmail').textContent = currentUser.email;
            loadLearningData();
        }

        async function showAdminMode() {
            if (!isAdmin) return;
            document.getElementById('learningSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            switchAdminTab('dashboard');
        }

        // --- Learning Logic ---

        async function loadLearningData() {
            await Promise.all([
                supabase.from('categories').select('*').order('display_order').then(res => categories = res.data || []),
                supabase.from('progress').select('lesson_id, feedback_text').eq('user_id', currentUser.id).then(res => userProgress = res.data || [])
            ]);
            renderCategories();
        }

        function renderCategories() {
            document.getElementById('categoryView').classList.remove('hidden');
            document.getElementById('lessonView').classList.add('hidden');
            document.getElementById('breadcrumbSeparator').classList.add('hidden');
            document.getElementById('breadcrumbCurrent').classList.add('hidden');

            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'hover-card bg-white rounded-2xl p-6 border border-gray-100 cursor-pointer group';
                div.onclick = () => loadLessons(cat);
                div.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${cat.title}</h3>
                    <p class="text-sm text-gray-500">${cat.description || ''}</p>
                    <div class="mt-4 text-purple-600 font-bold text-sm">ã‚³ãƒ¼ã‚¹ã‚’é–‹ã â†’</div>
                `;
                list.appendChild(div);
            });
        }

        async function loadLessons(cat) {
            currentCategory = cat;
            const { data } = await supabase.from('lessons').select('*').eq('category_id', cat.id).order('lesson_order');
            lessons = data || [];

            document.getElementById('categoryView').classList.add('hidden');
            document.getElementById('lessonView').classList.remove('hidden');
            document.getElementById('breadcrumbSeparator').classList.remove('hidden');
            document.getElementById('breadcrumbCurrent').classList.remove('hidden').textContent = cat.title;
            document.getElementById('currentCategoryTitle').textContent = cat.title;

            renderLessons();
        }

        function renderLessons() {
            const list = document.getElementById('lessonList');
            list.innerHTML = '';

            const completedCount = lessons.filter(l => userProgress.some(p => p.lesson_id === l.id)).length;
            const percent = lessons.length ? (completedCount / lessons.length) * 100 : 0;
            document.getElementById('courseProgressBar').style.width = percent + '%';

            lessons.forEach((l, i) => {
                const prev = i > 0 ? lessons[i - 1] : null;
                const isUnlocked = i === 0 || (prev && userProgress.some(p => p.lesson_id === prev.id));
                const isCompleted = userProgress.some(p => p.lesson_id === l.id);
                const vid = extractVideoId(l.video_url);
                const thumb = l.thumbnail_url || DEFAULT_THUMBNAIL;

                const div = document.createElement('div');
                div.className = `video-card bg-white rounded-2xl overflow-hidden card-shadow ${!isUnlocked ? 'opacity-70 grayscale' : 'hover-card'}`;
                div.innerHTML = `
                    <div class="relative">
                        <img src="${thumb}" class="w-full aspect-video object-cover">
                        ${!isUnlocked ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-bold">LOCKED</div>' : ''}
                        ${isCompleted ? '<div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded">âœ“ å®Œäº†</div>' : ''}
                    </div>
                    <div class="p-4">
                        <div class="text-xs text-gray-400 font-bold">LESSON ${l.lesson_order}</div>
                        <h4 class="font-bold mb-3 line-clamp-2">${l.title}</h4>
                        <button onclick="${isUnlocked ? `openVideo(${l.id})` : ''}" class="w-full py-2 rounded font-bold text-sm ${isUnlocked ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}">${isUnlocked ? (isCompleted ? 'å¾©ç¿’ã™ã‚‹' : 'å­¦ç¿’ã™ã‚‹') : 'ãƒ­ãƒƒã‚¯'}</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function openVideo(id) {
            activeLesson = lessons.find(l => l.id === id);
            const vid = extractVideoId(activeLesson.video_url);
            document.getElementById('modalLessonTitle').textContent = activeLesson.title;
            document.getElementById('videoPlayer').src = `https://www.youtube.com/embed/${vid}?autoplay=1`;

            const progress = userProgress.find(p => p.lesson_id === id);
            if (progress) {
                document.getElementById('feedbackFormContainer').classList.add('hidden');
                document.getElementById('completedView').classList.remove('hidden');
                document.getElementById('pastFeedback').textContent = progress.feedback_text;
            } else {
                document.getElementById('feedbackFormContainer').classList.remove('hidden');
                document.getElementById('completedView').classList.add('hidden');
                document.getElementById('feedbackText').value = '';
                document.getElementById('minCharCount').textContent = activeLesson.min_feedback_length || 20;
                validateFeedback();
            }
            document.getElementById('videoModal').classList.remove('hidden');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('videoPlayer').src = '';
        }

        function validateFeedback() {
            const len = document.getElementById('feedbackText').value.length;
            const min = activeLesson.min_feedback_length || 20;
            const remaining = min - len;
            const btn = document.getElementById('submitFeedbackBtn');
            const status = document.getElementById('statusMessage');
            if (remaining > 0) {
                status.innerHTML = `ã‚ã¨${remaining}æ–‡å­—`;
                status.className = 'text-xs text-red-500 font-medium';
                btn.disabled = true;
            } else {
                status.textContent = 'é€ä¿¡å¯èƒ½';
                status.className = 'text-xs text-green-500 font-medium';
                btn.disabled = false;
            }
            document.getElementById('charCount').textContent = len + 'æ–‡å­—';
        }

        async function submitFeedback() {
            const text = document.getElementById('feedbackText').value;
            const { error } = await supabase.from('progress').insert({ user_id: currentUser.id, lesson_id: activeLesson.id, feedback_text: text });
            if (error) { alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼'); return; }
            userProgress.push({ lesson_id: activeLesson.id, feedback_text: text });
            renderLessons();
            closeVideoModal();
        }

        // --- Admin Logic ---

        function switchAdminTab(tab) {
            ['dashboard', 'categories', 'lessons', 'users'].forEach(t => {
                document.getElementById('nav-' + t).classList.toggle('active', t === tab);
                document.getElementById('view-' + t).classList.toggle('hidden', t !== tab);
            });
            document.getElementById('adminPageTitle').textContent = { 'dashboard': 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', 'categories': 'ã‚«ãƒ†ã‚´ãƒªç®¡ç†', 'lessons': 'ãƒ¬ãƒƒã‚¹ãƒ³ç®¡ç†', 'users': 'ä¼šå“¡é€²æ—' }[tab];
            if (tab === 'dashboard') loadAdminDashboard();
            if (tab === 'categories') loadAdminCategories();
            if (tab === 'lessons') loadAdminLessons();
            if (tab === 'users') loadAdminUsers();
        }

        async function loadAdminDashboard() {
            const [u, f, l, feed] = await Promise.all([
                supabase.from('profiles').select('*', { count: 'exact', head: true }),
                supabase.from('progress').select('*', { count: 'exact', head: true }),
                supabase.from('lessons').select('*', { count: 'exact', head: true }),
                supabase.from('progress').select('*, lessons(title)').order('completed_at', { ascending: false }).limit(5)
            ]);
            document.getElementById('stat-users').textContent = u.count || '-';
            document.getElementById('stat-feedback').textContent = f.count || '-';
            document.getElementById('stat-lessons').textContent = l.count || '-';

            const tl = document.getElementById('feed-timeline');
            tl.innerHTML = '';
            (feed.data || []).forEach(i => {
                tl.innerHTML += `<div class="p-4 text-sm"><div class="font-bold flex justify-between"><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><span class="text-gray-400 font-normal">${new Date(i.completed_at).toLocaleDateString()}</span></div><div class="text-purple-600 text-xs mb-1">${i.lessons?.title}</div><div class="bg-gray-50 p-2 rounded text-gray-600">"${i.feedback_text}"</div></div>`;
            });
        }

        async function loadAdminCategories() {
            const { data } = await supabase.from('categories').select('*').order('display_order');
            const tb = document.getElementById('adminCategoryTable');
            tb.innerHTML = '';
            data.forEach(c => {
                tb.innerHTML += `<tr class="border-b last:border-0 hover:bg-gray-50"><td class="p-4 text-gray-500">#${c.display_order}</td><td class="p-4 font-bold">${c.title}</td><td class="p-4 text-xs text-gray-500 truncate max-w-xs">${c.description || ''}</td><td class="p-4 text-right"><button onclick="deleteCategory(${c.id})" class="text-red-500 text-xs font-bold hover:underline">å‰Šé™¤</button></td></tr>`;
            });
        }

        async function loadAdminLessons() {
            const { data: cats } = await supabase.from('categories').select('id, title');
            const { data: less } = await supabase.from('lessons').select('*').order('category_id').order('lesson_order');
            const tb = document.getElementById('adminLessonTable');
            tb.innerHTML = '';
            less.forEach(l => {
                const cTitle = cats.find(c => c.id === l.category_id)?.title || '?';
                tb.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${cTitle}</span></td><td class="p-4 text-gray-500">#${l.lesson_order}</td><td class="p-4 font-bold"><a href="${l.video_url}" target="_blank" class="hover:text-blue-500">${l.title}</a></td><td class="p-4 text-right"><button onclick="deleteLesson(${l.id})" class="text-red-500 text-xs font-bold hover:underline">å‰Šé™¤</button></td></tr>`;
            });

            const sel = document.getElementById('lessonCategorySelect');
            sel.innerHTML = '';
            cats.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.title}</option>`);
        }

        async function loadAdminUsers() {
            const { data } = await supabase.from('progress').select('*');
            const map = {};
            data.forEach(p => {
                if (!map[p.user_id]) map[p.user_id] = { c: 0, last: '' };
                map[p.user_id].c++;
                map[p.user_id].last = p.completed_at;
            });
            const tb = document.getElementById('adminUserTable');
            tb.innerHTML = '';
            Object.entries(map).forEach(([uid, val]) => {
                tb.innerHTML += `<tr class="border-b"><td class="p-4 font-mono text-xs">${uid}</td><td class="p-4 font-bold text-center">${val.c}</td><td class="p-4 text-sm">${new Date(val.last).toLocaleDateString()}</td></tr>`;
            });
        }

        // --- Admin Actions ---
        function openCategoryModal() { document.getElementById('categoryModal').classList.remove('hidden'); document.getElementById('categoryModal').classList.add('flex'); }
        function openLessonModal() { document.getElementById('lessonModal').classList.remove('hidden'); document.getElementById('lessonModal').classList.add('flex'); }
        async function handleCategorySubmit(e) {
            e.preventDefault();
            const f = e.target;
            const { error } = await supabase.from('categories').insert({ title: f.title.value, description: f.description.value, display_order: f.order.value });
            if (!error) { f.reset(); document.getElementById('categoryModal').classList.add('hidden'); loadAdminCategories(); }
        }
        async function handleLessonSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const { error } = await supabase.from('lessons').insert({ category_id: f.category_id.value, title: f.title.value, video_url: f.video_url.value, thumbnail_url: f.thumbnail_url.value || null, lesson_order: f.order.value, min_feedback_length: f.min_length.value });
            if (!error) { f.reset(); document.getElementById('lessonModal').classList.add('hidden'); loadAdminLessons(); }
        }
        async function deleteCategory(id) { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { await supabase.from('categories').delete().eq('id', id); loadAdminCategories(); } }
        async function deleteLesson(id) { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { await supabase.from('lessons').delete().eq('id', id); loadAdminLessons(); } }

    </script>
</body>

</html>
