<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaCampus - è–¬å‰¤å¸«å‘ã‘å‹•ç”»å­¦ç¿’ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans JP', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .locked-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        .requirement-met {
            color: #10b981;
        }
        .requirement-unmet {
            color: #ef4444;
        }
        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        .video-card {
            transition: all 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ========================================
         Supabase åˆæœŸåŒ–
    ======================================== -->
    <script>
        // Supabaseè¨­å®šï¼ˆã”è‡ªèº«ã®ã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
        const SUPABASE_URL = 'ã€ã‚ãªãŸã®Supabase URLã€‘';
        const SUPABASE_KEY = 'ã€ã‚ãªãŸã®Supabase Keyã€‘';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let lessons = [];
        let userProgress = [];
    </script>

    <!-- ========================================
         ãƒ˜ãƒƒãƒ€ãƒ¼
    ======================================== -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">PharmaCampus</h1>
                </div>
                <div id="userInfo" class="hidden items-center space-x-4">
                    <span id="userEmail" class="text-sm opacity-90"></span>
                    <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ========================================
         é€²æ—ãƒãƒ¼
    ======================================== -->
    <div id="progressSection" class="hidden bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">å­¦ç¿’é€²æ—</span>
                <span id="progressText" class="text-sm font-bold text-purple-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="progressBar" class="progress-bar h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- ========================================
         ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    ======================================== -->
    <main class="container mx-auto px-4 py-8">
        <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="authSection" class="max-w-md mx-auto">
            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="flex mb-6 bg-white rounded-xl p-1 card-shadow">
                <button id="loginTab" onclick="showTab('login')" class="flex-1 py-3 px-4 rounded-lg font-medium transition bg-purple-600 text-white">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                <button id="registerTab" onclick="showTab('register')" class="flex-1 py-3 px-4 rounded-lg font-medium transition text-gray-600 hover:bg-gray-100">
                    æ–°è¦ç™»éŒ²
                </button>
            </div>

            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="loginForm" class="bg-white rounded-2xl p-8 card-shadow fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="loginEmail" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="example@email.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="loginPassword" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-medium">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </form>
                <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
            </div>

            <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="registerForm" class="bg-white rounded-2xl p-8 card-shadow fade-in hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">æ–°è¦ç™»éŒ²</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="registerEmail" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="example@email.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="registerPassword" required oninput="checkPasswordStrength()"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯è¡¨ç¤º -->
                        <div id="passwordRequirements" class="mt-3 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶:</p>
                            <ul class="text-sm space-y-1">
                                <li id="req-length" class="flex items-center space-x-2 requirement-unmet">
                                    <span id="req-length-icon">âœ—</span>
                                    <span>10æ–‡å­—ä»¥ä¸Š</span>
                                </li>
                                <li id="req-upper" class="flex items-center space-x-2 requirement-unmet">
                                    <span id="req-upper-icon">âœ—</span>
                                    <span>å¤§æ–‡å­—ã‚’å«ã‚€ (A-Z)</span>
                                </li>
                                <li id="req-lower" class="flex items-center space-x-2 requirement-unmet">
                                    <span id="req-lower-icon">âœ—</span>
                                    <span>å°æ–‡å­—ã‚’å«ã‚€ (a-z)</span>
                                </li>
                                <li id="req-number" class="flex items-center space-x-2 requirement-unmet">
                                    <span id="req-number-icon">âœ—</span>
                                    <span>æ•°å­—ã‚’å«ã‚€ (0-9)</span>
                                </li>
                                <li id="req-symbol" class="flex items-center space-x-2 requirement-unmet">
                                    <span id="req-symbol-icon">âœ—</span>
                                    <span>è¨˜å·ã‚’å«ã‚€ (!@#$%ãªã©)</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            è–¬å‰¤å¸«å…è¨±ç•ªå· <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="licenseNumber" required oninput="validateLicenseNumber()"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="åŠè§’æ•°å­—ã®ã¿ï¼ˆä¾‹: 123456ï¼‰"
                            pattern="[0-9]+"
                            title="åŠè§’æ•°å­—ã®ã¿å…¥åŠ›å¯èƒ½ã§ã™">
                        <p id="licenseError" class="mt-1 text-sm text-red-500 hidden">åŠè§’æ•°å­—ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>
                    <button type="submit" id="registerButton" disabled
                        class="w-full btn-primary text-white py-3 rounded-lg font-medium disabled:opacity-50">
                        æ–°è¦ç™»éŒ²
                    </button>
                </form>
                <div id="registerError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
                <div id="registerSuccess" class="mt-4 text-green-500 text-sm text-center hidden"></div>
            </div>
        </div>

        <!-- å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="learningSection" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“š ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§</h2>
                <p class="text-gray-600">é †ç•ªã«å‹•ç”»ã‚’è¦–è´ã—ã€å­¦ç¿’ã‚’é€²ã‚ã¾ã—ã‚‡ã†</p>
            </div>
            
            <div id="lessonList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <!-- ãƒ¬ãƒƒã‚¹ãƒ³ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
        </div>

        <!-- å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="videoModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                    <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="aspect-video bg-black">
                    <iframe id="videoPlayer" class="w-full h-full" frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
                </div>
                <div class="p-4 border-t">
                    <button id="completeButton" onclick="completeLesson()"
                        class="w-full btn-primary text-white py-3 rounded-lg font-medium flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>å®Œäº†ã—ã¦æ¬¡ã¸</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ========================================
         ãƒ•ãƒƒã‚¿ãƒ¼
    ======================================== -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">Â© 2024 PharmaCampus. All rights reserved.</p>
            <p class="text-sm text-gray-500 mt-2">è–¬å‰¤å¸«ã®ãŸã‚ã®ç¶™ç¶šå­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
        </div>
    </footer>

    <!-- ========================================
         JavaScript
    ======================================== -->
    <script>
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ¬ãƒƒã‚¹ãƒ³ID
        let currentLessonId = null;

        // ========================================
        // èªè¨¼é–¢é€£
        // ========================================
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('bg-purple-600', 'text-white');
                loginTab.classList.remove('text-gray-600');
                registerTab.classList.remove('bg-purple-600', 'text-white');
                registerTab.classList.add('text-gray-600');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('bg-purple-600', 'text-white');
                registerTab.classList.remove('text-gray-600');
                loginTab.classList.remove('bg-purple-600', 'text-white');
                loginTab.classList.add('text-gray-600');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯
        function checkPasswordStrength() {
            const password = document.getElementById('registerPassword').value;
            
            const requirements = {
                length: password.length >= 10,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                symbol: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            // å„æ¡ä»¶ã®è¡¨ç¤ºã‚’æ›´æ–°
            Object.keys(requirements).forEach(key => {
                const element = document.getElementById(`req-${key}`);
                const icon = document.getElementById(`req-${key}-icon`);
                if (requirements[key]) {
                    element.classList.remove('requirement-unmet');
                    element.classList.add('requirement-met');
                    icon.textContent = 'âœ“';
                } else {
                    element.classList.remove('requirement-met');
                    element.classList.add('requirement-unmet');
                    icon.textContent = 'âœ—';
                }
            });

            // å…¨æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const allMet = Object.values(requirements).every(v => v);
            updateRegisterButton();
            
            return allMet;
        }

        // è–¬å‰¤å¸«å…è¨±ç•ªå·ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateLicenseNumber() {
            const input = document.getElementById('licenseNumber');
            const error = document.getElementById('licenseError');
            const value = input.value;
            
            // åŠè§’æ•°å­—ä»¥å¤–ã‚’é™¤å»
            const cleanValue = value.replace(/[^0-9]/g, '');
            
            if (value !== cleanValue) {
                input.value = cleanValue;
                error.classList.remove('hidden');
            } else {
                error.classList.add('hidden');
            }
            
            updateRegisterButton();
            return cleanValue.length > 0;
        }

        // ç™»éŒ²ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
        function updateRegisterButton() {
            const button = document.getElementById('registerButton');
            const passwordValid = checkPasswordStrengthOnly();
            const licenseValid = document.getElementById('licenseNumber').value.length > 0;
            const emailValid = document.getElementById('registerEmail').value.length > 0;
            
            button.disabled = !(passwordValid && licenseValid && emailValid);
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆUIæ›´æ–°ãªã—ï¼‰
        function checkPasswordStrengthOnly() {
            const password = document.getElementById('registerPassword').value;
            return password.length >= 10 &&
                   /[A-Z]/.test(password) &&
                   /[a-z]/.test(password) &&
                   /[0-9]/.test(password) &&
                   /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                showLearningSection();
            } catch (error) {
                errorDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // æ–°è¦ç™»éŒ²å‡¦ç†
        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const licenseNumber = document.getElementById('licenseNumber').value;
            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!checkPasswordStrengthOnly()) {
                errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å…¨ã¦ã®è¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!/^[0-9]+$/.test(licenseNumber)) {
                errorDiv.textContent = 'è–¬å‰¤å¸«å…è¨±ç•ªå·ã¯åŠè§’æ•°å­—ã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Supabase Authã§ç™»éŒ²
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });
                
                if (error) throw error;
                
                // profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ æƒ…å ±ã‚’ä¿å­˜
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert({
                        id: data.user.id,
                        email: email,
                        license_number: licenseNumber
                    });
                
                if (profileError) throw profileError;
                
                errorDiv.classList.add('hidden');
                successDiv.textContent = 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚';
                successDiv.classList.remove('hidden');
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                setTimeout(() => {
                    showTab('login');
                    successDiv.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                errorDiv.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            userProgress = [];
            showAuthSection();
        }

        // ========================================
        // UIè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        
        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('learningSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('flex');
        }

        function showLearningSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('learningSection').classList.remove('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('flex');
            document.getElementById('userEmail').textContent = currentUser.email;
            
            loadLessons();
        }

        // ========================================
        // ãƒ¬ãƒƒã‚¹ãƒ³é–¢é€£
        // ========================================
        
        async function loadLessons() {
            try {
                // ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§ã‚’å–å¾—
                const { data: lessonsData, error: lessonsError } = await supabase
                    .from('lessons')
                    .select('*')
                    .order('lesson_order', { ascending: true });
                
                if (lessonsError) throw lessonsError;
                lessons = lessonsData;
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€²æ—ã‚’å–å¾—
                const { data: progressData, error: progressError } = await supabase
                    .from('progress')
                    .select('lesson_id')
                    .eq('user_id', currentUser.id);
                
                if (progressError) throw progressError;
                userProgress = progressData.map(p => p.lesson_id);
                
                renderLessons();
                updateProgressBar();
            } catch (error) {
                console.error('ãƒ¬ãƒƒã‚¹ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function renderLessons() {
            const container = document.getElementById('lessonList');
            container.innerHTML = '';
            
            lessons.forEach((lesson, index) => {
                const isCompleted = userProgress.includes(lesson.id);
                const isUnlocked = index === 0 || userProgress.includes(lessons[index - 1].id);
                
                const card = document.createElement('div');
                card.className = `video-card bg-white rounded-2xl overflow-hidden card-shadow ${!isUnlocked ? 'opacity-75' : ''}`;
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="https://img.youtube.com/vi/${lesson.youtube_id}/maxresdefault.jpg" 
                             alt="${lesson.title}" 
                             class="w-full aspect-video object-cover"
                             onerror="this.src='https://img.youtube.com/vi/${lesson.youtube_id}/hqdefault.jpg'">
                        ${!isUnlocked ? `
                            <div class="locked-overlay absolute inset-0 flex items-center justify-center">
                                <div class="text-center text-white">
                                    <svg class="w-12 h-12 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4zm0 10c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/>
                                    </svg>
                                    <p class="text-sm">å‰ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å®Œäº†ã—ã¦ãã ã•ã„</p>
                                </div>
                            </div>
                        ` : ''}
                        ${isCompleted ? `
                            <div class="absolute top-3 right-3 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>å®Œäº†</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-5">
                        <div class="flex items-center space-x-2 text-sm text-purple-600 font-medium mb-2">
                            <span>ç¬¬${lesson.lesson_order}å›</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-3">${lesson.title}</h3>
                        <button 
                            onclick="openVideoModal(${lesson.id})"
                            ${!isUnlocked ? 'disabled' : ''}
                            class="w-full py-2 rounded-lg font-medium transition ${
                                isUnlocked 
                                    ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            }">
                            ${isUnlocked ? (isCompleted ? 'å¾©ç¿’ã™ã‚‹' : 'è¦–è´ã™ã‚‹') : 'ãƒ­ãƒƒã‚¯ä¸­'}
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function updateProgressBar() {
            const totalLessons = lessons.length;
            const completedLessons = userProgress.length;
            const percentage = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${percentage}% (${completedLessons}/${totalLessons})`;
        }

        // ========================================
        // å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ«
        // ========================================
        
        function openVideoModal(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            currentLessonId = lessonId;
            
            document.getElementById('modalTitle').textContent = `ç¬¬${lesson.lesson_order}å›: ${lesson.title}`;
            document.getElementById('videoPlayer').src = `https://www.youtube.com/embed/${lesson.youtube_id}?autoplay=1`;
            
            // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
            const isCompleted = userProgress.includes(lessonId);
            const completeButton = document.getElementById('completeButton');
            if (isCompleted) {
                completeButton.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span>å®Œäº†æ¸ˆã¿ï¼ˆé–‰ã˜ã‚‹ï¼‰</span>
                `;
            } else {
                completeButton.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span>å®Œäº†ã—ã¦æ¬¡ã¸</span>
                `;
            }
            
            document.getElementById('videoModal').classList.remove('hidden');
            document.getElementById('videoModal').classList.add('flex');
        }

        function closeVideoModal() {
            document.getElementById('videoPlayer').src = '';
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('videoModal').classList.remove('flex');
            currentLessonId = null;
        }

        async function completeLesson() {
            if (!currentLessonId) return;
            
            // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹ã ã‘
            if (userProgress.includes(currentLessonId)) {
                closeVideoModal();
                return;
            }
            
            try {
                // é€²æ—ã‚’ä¿å­˜
                const { error } = await supabase
                    .from('progress')
                    .insert({
                        user_id: currentUser.id,
                        lesson_id: currentLessonId
                    });
                
                if (error) throw error;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã®é€²æ—ã‚’æ›´æ–°
                userProgress.push(currentLessonId);
                
                // UIã‚’æ›´æ–°
                renderLessons();
                updateProgressBar();
                closeVideoModal();
                
            } catch (error) {
                console.error('é€²æ—ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('é€²æ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        
        async function init() {
            // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showLearningSection();
            } else {
                showAuthSection();
            }
            
            // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    showLearningSection();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showAuthSection();
                }
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ™‚ã«ã‚‚ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        document.getElementById('registerEmail').addEventListener('input', updateRegisterButton);
    </script>
</body>
</html>
