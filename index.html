<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacist Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-gray-800 font-sans min-h-screen">

    <nav class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸ’Š</span> PharmaClass
            </h1>
            <div id="auth-ui"></div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-3xl mt-6">

        <div id="login-screen" class="bg-white p-8 rounded-lg shadow-lg hidden max-w-md mx-auto mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center text-teal-700">è–¬å‰¤å¸«ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h2>
            
            <div class="flex gap-4 mb-6 justify-center">
                <button onclick="switchMode('login')" id="btn-mode-login" class="font-bold border-b-2 border-teal-600 pb-1">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button onclick="switchMode('signup')" id="btn-mode-signup" class="text-gray-400 pb-1">æ–°è¦ç™»éŒ²</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-gray-600">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="email" placeholder="example@pharmacy.jp" class="w-full border p-3 rounded mt-1 focus:ring-2 focus:ring-teal-500 outline-none">
                </div>
                
                <div id="license-field" class="hidden">
                    <label class="block text-sm font-bold text-gray-600 mb-1">è–¬å‰¤å¸«å…è¨±ç•ªå· <span class="text-red-500">*</span></label>
                    <input type="text" id="license" placeholder="ä¾‹: 123456" class="w-full border p-3 rounded focus:ring-2 focus:ring-teal-500 outline-none" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    <p class="text-xs text-gray-400 mt-1">â€»åŠè§’æ•°å­—ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>

                <div>
                    <label class="text-sm font-bold text-gray-600">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full border p-3 rounded mt-1 focus:ring-2 focus:ring-teal-500 outline-none" oninput="checkPassword()">
                    <div id="password-rules" class="hidden text-xs mt-2 p-3 bg-gray-50 rounded border">
                        <p class="font-bold mb-2">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶:</p>
                        <ul class="space-y-1">
                            <li id="rule-len" class="text-gray-400 flex items-center gap-1"><span>âŒ</span> 10æ–‡å­—ä»¥ä¸Š</li>
                            <li id="rule-upper" class="text-gray-400 flex items-center gap-1"><span>âŒ</span> å¤§æ–‡å­— (A-Z)</li>
                            <li id="rule-lower" class="text-gray-400 flex items-center gap-1"><span>âŒ</span> å°æ–‡å­— (a-z)</li>
                            <li id="rule-num" class="text-gray-400 flex items-center gap-1"><span>âŒ</span> æ•°å­— (0-9)</li>
                            <li id="rule-sym" class="text-gray-400 flex items-center gap-1"><span>âŒ</span> è¨˜å· (!@#$ãªã©)</li>
                        </ul>
                    </div>
                </div>

                <button id="action-btn" onclick="handleAuth()" class="w-full bg-teal-600 text-white font-bold py-3 rounded hover:bg-teal-700 transition shadow-md mt-4">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <p id="error-msg" class="text-red-500 text-sm text-center font-bold mt-2"></p>
            </div>
        </div>

        <div id="app-screen" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-teal-500">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="font-bold text-lg text-gray-700">ç¾åœ¨ã®å­¦ç¿’é€²æ—</h2>
                    <span id="progress-text" class="text-3xl font-bold text-teal-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="bg-teal-500 h-4 rounded-full transition-all duration-1000 ease-out relative" style="width: 0%">
                        <div class="absolute inset-0 bg-white opacity-20" style="background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem;"></div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-2">å‹•ç”»ä¸‹ã®ã€Œå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨é€²æ—ãŒé€²ã¿ã¾ã™ã€‚</p>
            </div>

            <div id="lesson-list" class="space-y-6 pb-10"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // â˜…è¨­å®šå®Œäº†æ¸ˆã¿ï¼šã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±â˜…
        // ==========================================
        const SUPABASE_URL = 'https://jzymudoembgafbdcmjni.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6eW11ZG9lbWJnYWZiZGNtam5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzM3NjMsImV4cCI6MjA4MTAwOTc2M30.pTihcUOuDdmBNyE8qSzuEJLcqODn-iKBKelFNr2rB-8';
        // ==========================================

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let isSignupMode = false;
        let currentUser = null;

        // åˆæœŸåŒ–å‡¦ç†
        async function init() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                if (session) {
                    currentUser = session.user;
                    showApp();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            } catch (err) {
                console.error("Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:", err);
            }
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function switchMode(mode) {
            isSignupMode = (mode === 'signup');
            document.getElementById('license-field').classList.toggle('hidden', !isSignupMode);
            document.getElementById('password-rules').classList.toggle('hidden', !isSignupMode);
            document.getElementById('action-btn').innerText = isSignupMode ? "æ–°è¦ç™»éŒ²ã—ã¦å§‹ã‚ã‚‹" : "ãƒ­ã‚°ã‚¤ãƒ³";
            
            const activeClass = "font-bold border-b-2 border-teal-600 text-teal-800";
            const inactiveClass = "text-gray-400 hover:text-gray-600";
            
            document.getElementById('btn-mode-signup').className = isSignupMode ? `${activeClass} pb-1` : `${inactiveClass} pb-1`;
            document.getElementById('btn-mode-login').className = !isSignupMode ? `${activeClass} pb-1` : `${inactiveClass} pb-1`;
            
            document.getElementById('error-msg').innerText = "";
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
        function checkPassword() {
            if (!isSignupMode) return true;
            const pw = document.getElementById('password').value;
            const rules = {
                len: pw.length >= 10,
                upper: /[A-Z]/.test(pw),
                lower: /[a-z]/.test(pw),
                num: /[0-9]/.test(pw),
                sym: /[\W_]/.test(pw)
            };

            for (const [key, valid] of Object.entries(rules)) {
                const el = document.getElementById(`rule-${key}`);
                const icon = valid ? 'âœ…' : 'âŒ';
                const text = el.innerText.substring(2);
                el.innerHTML = `<span>${icon}</span> ${text}`;
                el.className = valid ? "text-green-600 font-bold flex items-center gap-1 transition-colors" : "text-gray-400 flex items-center gap-1 transition-colors";
            }
            return Object.values(rules).every(Boolean);
        }

        // èªè¨¼å‡¦ç†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²ï¼‰
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const license = document.getElementById('license').value;
            const errorEl = document.getElementById('error-msg');
            const btn = document.getElementById('action-btn');

            errorEl.innerText = "";

            if (!email || !password) {
                errorEl.innerText = "ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                return;
            }

            btn.disabled = true;
            btn.innerText = "å‡¦ç†ä¸­...";

            try {
                if (isSignupMode) {
                    if (!checkPassword()) throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ãã ã•ã„");
                    if (!license) throw new Error("è–¬å‰¤å¸«å…è¨±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

                    // ç™»éŒ²å‡¦ç†
                    const { data, error } = await supabase.auth.signUp({
                        email, 
                        password,
                        options: { data: { license_number: license } }
                    });
                    if (error) throw error;
                    
                    // Supabaseã®è¨­å®šã«ã‚ˆã£ã¦ã¯ã€ãƒ¡ãƒ¼ãƒ«ç¢ºèªãªã—ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹å ´åˆã¨ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™
                    // ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒå¿…è¦ãªè¨­å®šã®å ´åˆã«å‚™ãˆã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
                    alert("ç™»éŒ²ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\nãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚\n(â€»ã‚‚ã—ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’OFFã«ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãã®ã¾ã¾ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„)");
                    switchMode('login'); 
                } else {
                    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    location.reload();
                }
            } catch (err) {
                errorEl.innerText = err.message;
            } finally {
                btn.disabled = false;
                btn.innerText = isSignupMode ? "æ–°è¦ç™»éŒ²ã—ã¦å§‹ã‚ã‚‹" : "ãƒ­ã‚°ã‚¤ãƒ³";
            }
        }

        // ã‚¢ãƒ—ãƒªç”»é¢è¡¨ç¤º
        async function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('auth-ui').innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-sm hidden md:inline opacity-90">${currentUser.email}</span>
                    <button onclick="logout()" class="text-sm bg-teal-800 text-teal-100 px-3 py-1 rounded hover:bg-teal-900 transition">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>`;

            // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const { data: lessons, error: l_err } = await supabase.from('lessons').select('*').order('lesson_order');
            const { data: myProgress, error: p_err } = await supabase.from('progress').select('lesson_id').eq('user_id', currentUser.id);
            
            if(l_err) { alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: " + l_err.message); return; }

            const completedIds = myProgress ? myProgress.map(p => p.lesson_id) : [];

            // é€²æ—è¨ˆç®—
            const percent = lessons.length > 0 ? Math.round((completedIds.length / lessons.length) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;

            // ãƒªã‚¹ãƒˆæç”»
            const list = document.getElementById('lesson-list');
            list.innerHTML = "";

            lessons.forEach((lesson, i) => {
                let isLocked = false;
                // ãƒ­ãƒƒã‚¯æ¡ä»¶: 1ã¤ç›®ã§ã¯ãªãã€ã‹ã¤å‰ã®å‹•ç”»ãŒçµ‚ã‚ã£ã¦ã„ãªã„å ´åˆ
                if (i > 0 && !completedIds.includes(lessons[i-1].id)) {
                    isLocked = true;
                }
                // è‡ªåˆ†ãŒçµ‚ã‚ã£ã¦ã„ã‚Œã°ãƒ­ãƒƒã‚¯è§£é™¤
                if (completedIds.includes(lesson.id)) isLocked = false;

                const isDone = completedIds.includes(lesson.id);
                
                const html = `
                    <div class="border rounded-lg overflow-hidden bg-white shadow-sm transition hover:shadow-md ${isLocked ? 'opacity-70 bg-gray-50' : ''}">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-gray-800">
                                <span class="bg-teal-100 text-teal-800 text-xs px-2 py-1 rounded mr-2">ç¬¬${lesson.lesson_order}å›</span>
                                ${lesson.title}
                            </h3>
                            ${isDone ? '<span class="text-green-600 font-bold text-sm bg-green-100 px-2 py-1 rounded flex items-center gap-1">âœ… å®Œäº†</span>' : ''}
                            ${isLocked ? '<span class="text-gray-500 font-bold text-sm bg-gray-200 px-2 py-1 rounded flex items-center gap-1">ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­</span>' : ''}
                        </div>
                        <div class="p-4">
                            ${isLocked 
                                ? `<div class="h-48 bg-gray-200 rounded flex flex-col items-center justify-center text-gray-500 gap-2">
                                     <span class="text-2xl">ğŸ”’</span>
                                     <span>å‰ã®å‹•ç”»ã‚’å­¦ç¿’å®Œäº†ã™ã‚‹ã¨è¦–è´ã§ãã¾ã™</span>
                                   </div>`
                                : `<div class="aspect-video w-full mb-4 bg-black rounded relative overflow-hidden">
                                     <iframe class="w-full h-full absolute top-0 left-0" src="https://www.youtube.com/embed/${lesson.youtube_id}" frameborder="0" allowfullscreen></iframe>
                                   </div>
                                   ${!isDone 
                                     ? `<button onclick="completeLesson(${lesson.id})" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 shadow transition flex justify-center items-center gap-2">
                                        <span>ğŸ‘‰</span> ã“ã®å‹•ç”»ã‚’å­¦ç¿’å®Œäº†ã—ã¦æ¬¡ã¸
                                        </button>` 
                                     : `<div class="text-center text-teal-600 font-bold py-2 bg-teal-50 rounded">ğŸ‰ å­¦ç¿’å®Œäº†ã—ã¾ã—ãŸï¼</div>`
                                   }`
                            }
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        async function completeLesson(id) {
            if(!confirm("å‹•ç”»ã®å†…å®¹ã‚’ç†è§£ã—ã¾ã—ãŸã‹ï¼Ÿ\nã€ŒOKã€ã‚’æŠ¼ã™ã¨å­¦ç¿’å®Œäº†ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚")) return;
            
            const { error } = await supabase.from('progress').insert({ 
                user_id: currentUser.id, 
                lesson_id: id 
            });

            if(error) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
            } else {
                alert("ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼é€²æ—ãŒè¨˜éŒ²ã•ã‚Œã€æ¬¡ã®å‹•ç”»ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸğŸ‰");
                location.reload();
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }

        init();
    </script>
</body>
</html>